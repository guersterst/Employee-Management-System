<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"> -->
    <link rel="stylesheet" href="../static/css/employeeHomePage.css" type="text/css"
          th:href="@{/css/employeeHomePage.css}">
    <link href="/webjars/bootstrap/5.0.1/css/bootstrap.css" th:href="@{/webjars/bootstrap/5.0.1/css/bootstrap.css}"
          rel="stylesheet"/>
    <title>EmployeeManagement</title>
</head>

<nav>
    <div class="row">
        <div th:insert="'menubar'"></div>
    </div>
</nav>

<body>
<div class="contain container-fluid d-flex flex-column flex-fill">
    <div th:if="${isFirstLogin}" class="alert alert-danger"> Please change your password!
        <a th:href="@{/first-login}" id="changePassword" href="#"><i class="bi bi-person-bounding-box"></i> </a>
    </div>

    <div class="home">
        <h1 class="d-flex bg-secondary text-light">
            Home Page
        </h1>
        <h1>HTML5 - Geolocation<br>aktuellen Standort in einer OpenStreetmap-Karte ausgeben</h1>
        <main>
            <p>Sobald Sie auf den Button klicken, werden Ihre Koordinaten ermittelt und in einem Kartenausschnitt ausgegeben.</p>
            <button id="los">Los!</button>
            <div id="karte"></div>
        </main>
    </div>
    <div class="row" th:action="@{/my-session/latest}" th:object="${workSessionData}" th:method="post">
        <div class="form-group col-sm-12 col-md-6" th:fragment="messageForm">
            <div class="message card shadow h-100">
                <div class="bg-secondary text-light">
                    <h2>Message</h2>
                </div>
                <!--Show saved message-->
                <form onsubmit="checkMessage(event);" id="messageCard"
                      th:action="@{/my-session/message}" th:method="post">
                    <div class="form-group mx-auto">
                        <label class="form-control" id="savedMsg" type="text"
                               th:text="${workSessionData.textStatus}"></label>
                    </div>
                    <!--Text field to leave a message-->
                    <div>
                        <div class="input-group-prepend">

                        </div>
                        <div class="input-group">
                            <span class="input-group-text">Notification</span>
                            <textarea class="form-control" aria-label="With textarea" placeholder="Leave a message..."
                                      id="message" th:field="*{textStatus}"></textarea>
                        </div>
                    </div>

                    <!--Message has to short. The minimum amount of characters should be 10.-->
                    <div class="alert alert-danger mx-auto" id="alertMessageToShort">
                        <div class="align-text-bottom">
                            <i class="bi bi-exclamation-circle"></i>
                            <strong>Message is to short. Please enter 10 or more characters.</strong>
                        </div>
                    </div>

                    <div class="alert alert-danger mx-auto" id="alertInputRequired">
                        <div class="align-text-bottom">
                            <i class="bi bi-exclamation-circle"></i>
                            <strong>Input required.</strong>
                        </div>
                    </div>

                    <div class="alert alert-danger mx-auto" id="alertDelete">
                        <div class="align-text-bottom">
                            <i class="bi bi-exclamation-circle"></i>
                            <strong>You have already delete your message.</strong>
                        </div>
                    </div>

                    <div class="alert alert-info mx-auto" id="alertDeleteValid">
                        <div class="align-text-bottom">
                            <i class="bi bi-info"></i>
                            <strong>Message successfully deleted.</strong>
                        </div>
                    </div>

                    <!--Options for message-->
                    <div class="message-util form-group">
                        <!--Message with a minimum length.-->
                        <button class=" btn btn-primary btn-lg center-block" type="submit" id="save-button">
                            Save
                        </button>
                        <!--Deletes the saved message above the textarea.-->
                    </div>
                </form>
                <form th:action="@{/my-session/message/delete}" method="post" onsubmit="checkReset(event)">
                    <button class="btn btn-primary btn-lg center-block" type="submit" id="delete-message">
                        Delete
                    </button>
                </form>
                <br><br>
            </div>
        </div>


        <!--Option toolbar-->
        <div class="col-sm-12 col-md-6">
            <div th:fragment="state">
                <div class="state card shadow h-25">
                    <div class="bg-secondary text-light">
                        <h2>State</h2>
                    </div>
                    <div class="options">
                        <!--User can change the state of availability.Within the first login this should be enabled.-->
                        <form th:action="@{/my-session/availability}" method="post" th:object="${workSessionData}"
                              th:method="post">
                            <div class="form-check form-switch d-table available">
                                <input class="checkbox form-check-input" type="checkbox" id="available" value="true"
                                       th:field="${workSessionData.available}" name="available">
                                <label class="form-check-label" for="available" id="isAdminLabel">Availability</label>
                            </div>
                            <button class="btn btn-primary btn-sm" type="submit" id="createAccountButton">Submit
                            </button>
                        </form>

                        <!--If checked before action-->
                        <div th:if="*{onSite == false}">
                            <form th:action="@{/my-session/beginning}" method="post" th:object="${workSessionData}"
                                  th:method="post">
                                <!--On Site should be automatically switched on when logged in the first time of a day
                                and only switched of if you leave work.-->
                                <div class="form-check form-switch d-table onSite">
                                    <input class="checkbox form-check-input" type="checkbox" id="beginning" value="true"
                                           th:field="${workSessionData.onSite}" name="onSite">
                                    <label class="form-check-label" for="beginning" id="startSession">OnSite</label>
                                </div>
                                <button class="btn btn-primary btn-sm" type="submit" id="beginSession">Submit
                                </button>
                            </form>
                        </div>
                        <div th:unless="*{onSite == false}">
                            <form th:action="@{/my-session/ending/}" method="post" th:object="${workSessionData}"
                                  th:method="post">
                                <div class="form-check form-switch d-table onSite">
                                    <input class="checkbox form-check-input" type="checkbox" id="ending" value="true"
                                           th:field="${workSessionData.onSite}" name="onSite">
                                    <label class="form-check-label" for="ending" id="leaveOnSite">OnSite</label>
                                </div>
                                <button class="btn btn-primary btn-sm" type="submit" id="endingSession">Submit
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card shadow h-50">
                <div class="bg-secondary text-light">
                    <h2>More...</h2>
                </div>
                <!--Timeline vertically shows every event that is happening during using the web application.-->
                    <div class="card-body" id="more">
                        <div class="profile">
                            <a th:href="@{/account/me}" id="profile" href="#"><i class="bi bi-person-bounding-box"></i> </a>
                            <label class="form-label" for="profile">User Profile</label>
                        </div>
                    </div>
                    <hr>
                    <div class="history">
                        <a th:href="@{/my-history}" id="historyLink" href="#"><i class="bi bi-clock-history"></i> </a>
                        <label class="form-label" for="historyLink">History</label>
                    </div>
                </div>
            </div>
        </div>


        <!--TODO:Correct apearence of header.-->
        <!--View latest chronic items-->

    </div>
</div>
<!--
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script> -->
<script src="/webjars/jquery/3.0.0/jquery.min.js"></script>
<script src="/webjars/popper.js/1.14.1/popper.min.js"></script>
<script src="/webjars/bootstrap/5.0.1/js/bootstrap.min.js"></script>
</body>

<!-- <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/openlayers/2.13.1/OpenLayers.js"></script>

<script lang="JavaScript" type="text/javascript">

    let alertMessageToShort = $('#alertMessageToShort');
    let alertInputRequired = $('#alertInputRequired');
    let alertDeleteValid = $('#alertDeleteValid');
    let alertDelete = $('#alertDelete');

    let savedMessage = document.getElementById("savedMsg");

    let messageWasToShort = false;
    let inputWasRequired = false;
    let deleteWasValid = false;
    let wasDeleted = false;


    //TODO: Store message.
    //TODO: Duplicated alert code. Maybe theres a better way.
    //Saves the written message in the textarea and show it at the top of the field.
    function checkMessage(event) {
        let message = document.getElementById("message").value;
        let minLength = 10;

        let trimMessage = message.replace(/ /g, "");

        updateAlerts();

        if (trimMessage.length === 0) {
            //Input is required.
            alertInputRequired.fadeIn(100);
            inputWasRequired = true;
            event.preventDefault();
        } else if (trimMessage.length < minLength) {
            //stops submitting and shows alert.
            alertMessageToShort.fadeIn(100);
            messageWasToShort = true;
        }
    }

    //Checks whether the message is successfully hidden or not.
    function checkReset(event) {
        let savedMessage = document.getElementById("savedMsg");

        updateAlerts();

        //TODO: AlertDelte do not show up.
        if (savedMessage.trim().length === 0) {
            alertDelete.fadeIn(100);
            alert("You have already deleted this message.");
            wasDeleted = true;
            event.preventDefault();
        } else {
            alertDeleteValid.fadeIn(100);
            alert("You successfully delete the message.");
            deleteWasValid = true;
            event.preventDefault();
        }
    }

    //Checks whether an alert is visible. If this is the case it is fade out.
    function updateAlerts() {
        if (messageWasToShort) {
            alertMessageToShort.fadeOut(1);
        }
        if (inputWasRequired) {
            alertInputRequired.fadeOut(1);
        }
        if (deleteWasValid) {
            alertDeleteValid.fadeOut(1);
        }
        if (wasDeleted) {
            alertDelete.fadeOut(1);
        }
    }

    //Do not show alert.
    alertMessageToShort.fadeOut(1);
    alertInputRequired.fadeOut(1);
    alertDelete.fadeOut(1);
    alertDeleteValid.fadeOut(1);

    window.onload = function () {
        updateAlerts();
        document.getElementById("message").value = "";
    }

    //Get location
    let position = document.getElementById("location");

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } else {
            position.innerHTML = "Geolocation is not supported by this browser.";
        }
    }

    function showPosition(position) {
        location.innerHTML = "Latitude: " + position.coords.latitude +
            "<br>Longitude: " + position.coords.longitude;
    }

    var button = document.getElementById('los');
    button.addEventListener('click', ermittlePosition);
    var ausgabe = document.getElementById('ausgabe');

    function ermittlePosition() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(zeigePosition, zeigeFehler);
        } else {
            ausgabe.innerHTML = 'Ihr Browser unterstützt keine Geolocation.';
        }
    }

    function zeigePosition(position) {
        map = new OpenLayers.Map('karte');
        map.addLayer(new OpenLayers.Layer.OSM());
        var lonLat = new OpenLayers.LonLat(position.coords.longitude, position.coords
            .latitude) //Mitte der Karte angeben
            .transform(new OpenLayers.Projection('EPSG:4326'), // transform from WGS 1984
                map.getProjectionObject() // to Spherical Mercator Projection
            );
        var zoom = 12;
        var markers = new OpenLayers.Layer.Markers('Markers'); //Marker einfügen
        map.addLayer(markers);
        markers.addMarker(new OpenLayers.Marker(lonLat));
        map.setCenter(lonLat, zoom);
    }

    function zeigeFehler(error) {
        switch (error.code) {
            case error.PERMISSION_DENIED:
                ausgabe.innerHTML = "Benutzer lehnte Standortabfrage ab."
                break;
            case error.POSITION_UNAVAILABLE:
                ausgabe.innerHTML = "Standortdaten sind nicht verfügbar."
                break;
            case error.TIMEOUT:
                ausgabe.innerHTML = "Die Standortabfrage dauerte zu lange (Time-out)."
                break;
            case error.UNKNOWN_ERROR:
                ausgabe.innerHTML = "unbekannter Fehler."
                break;
        }
    }

</script>

<!--Include the footer that contains the copyright info-->
<footer>
    <div th:insert="'footer'" class="embeddedFooter"></div>
</footer>

</html>